name: Web-Control
on:
  workflow_dispatch:

jobs:
  novnc:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Create VNC User
        run: |
          $password = "admin@123"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force

          if (-not (Get-LocalUser -Name "TOOLBOXLAP" -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name "TOOLBOXLAP" -Password $securePass -AccountNeverExpires
          }

          Add-LocalGroupMember -Group "Administrators" -Member "TOOLBOXLAP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "TOOLBOXLAP"

          echo "VNC_PASSWORD=$password" >> $env:GITHUB_ENV

      - name: Open Ports
        run: |
          netsh advfirewall firewall add rule name="VNC-Local" dir=in action=allow protocol=TCP localport=5900
          netsh advfirewall firewall add rule name="noVNC" dir=in action=allow protocol=TCP localport=6080

      - name: Download UltraVNC Portable
        run: |
          Invoke-WebRequest -Uri "https://www.uvnc.eu/download/1510/UltraVNC_1_3_60_X64.zip" -OutFile "C:\uvnc.zip"
          Expand-Archive -Path "C:\uvnc.zip" -DestinationPath "C:\uvnc"

      - name: Configure UltraVNC
        run: |
          $ini = "[ultravnc]`npasswd=`npasswd2="
          Set-Content -Path "C:\uvnc\UltraVNC.ini" -Value $ini -Encoding ASCII

      - name: Start UltraVNC Server
        run: |
          Start-Process "C:\uvnc\winvnc.exe" -ArgumentList "/run" -WindowStyle Hidden
          Start-Sleep -Seconds 5

      - name: Install noVNC
        run: |
          Invoke-WebRequest -Uri "https://github.com/novnc/noVNC/archive/refs/heads/master.zip" -OutFile "C:\novnc.zip"
          Expand-Archive -Path "C:\novnc.zip" -DestinationPath "C:\"
          Rename-Item "C:\noVNC-master" "C:\noVNC"

          Invoke-WebRequest -Uri "https://github.com/novnc/websockify/archive/refs/heads/master.zip" -OutFile "C:\websockify.zip"
          Expand-Archive -Path "C:\websockify.zip" -DestinationPath "C:\"
          Rename-Item "C:\websockify-master" "C:\websockify"

      - name: Start noVNC Proxy
        run: |
          Start-Process powershell -ArgumentList "python C:\websockify\websockify.py 6080 localhost:5900" -WindowStyle Hidden
          Start-Sleep -Seconds 5

      - name: Install cloudflared
        run: |
          Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "C:\cloudflared.exe"

      - name: Start Cloudflare Tunnel
        run: |
          Start-Process -FilePath "C:\cloudflared.exe" -ArgumentList "tunnel --url http://localhost:6080 --logfile C:\tunnel.log" -WindowStyle Hidden
          Start-Sleep -Seconds 10

          $log = Get-Content C:\tunnel.log -Raw
          $url = ($log | Select-String -Pattern "https://.*?\.trycloudflare\.com").Matches.Value

          if ($url) {
            echo "CF_URL=$url" >> $env:GITHUB_ENV
          } else {
            Write-Host "Không tìm thấy URL tạm thời trong log."
          }

      - name: Show Info
        run: |
          Write-Host "==============================="
          Write-Host "           WEB CONTROL"
          Write-Host "URL: $env:CF_URL/vnc.html"
          Write-Host "==============================="

      - name: Keep Alive
        run: |
          while ($true) {
            Write-Host "Still running at $env:CF_URL"
            Start-Sleep 300
          }
